# Development Dockerfile - includes dev-credentials.json
# Uses a multi-stage build: build in golang image, run in lightweight image

# --- build stage ---
FROM golang:1.24.7-alpine AS builder

WORKDIR /src

# Install git for go modules if needed
RUN apk add --no-cache git

# Copy go mod files and download dependencies
COPY go.mod go.sum ./
RUN go mod download

# Copy the source
COPY . .

# Set env for dev build
ENV APP_ENV=dev

# Build the binary
RUN go build -o /app/bin/server-dev ./cmd/server

# --- final stage ---
FROM alpine:3.18

# Create app dir
RUN mkdir -p /app/bin
WORKDIR /app

# Copy binary from builder
COPY --from=builder /app/bin/server-dev ./bin/server

# Copy dev credentials into image
COPY dev-credentials.json ./dev-credentials.json

# Expose same port used by app (if any). Adjust if different.
EXPOSE 8080

# Default command - set APP_ENV to dev
ENV APP_ENV=dev
CMD ["/app/bin/server"]
